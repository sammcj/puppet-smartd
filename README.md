Puppet smartd Module
====================

[![Build Status](https://travis-ci.org/jhoblitt/puppet-smartd.png)](https://travis-ci.org/jhoblitt/puppet-smartd)

#### Table of Contents

<!-- MarkdownTOC -->

- [Overview](#overview)
- [Description](#description)
  - [Forked](#forked)
- [Usage](#usage)
  - [Simple Usage](#simple-usage)
  - [Parameters](#parameters)
    - [`ensure`](#ensure)
    - [`package_name`](#package_name)
    - [`service_name`](#service_name)
    - [`service_ensure`](#service_ensure)
    - [`config_file`](#config_file)
    - [`devicescan`](#devicescan)
    - [`devicescan_options`](#devicescan_options)
    - [`devices`](#devices)
    - [`mail_to`](#mail_to)
    - [`warning_schedule`](#warning_schedule)
    - [`exec_script`](#exec_script)
    - [`enable_default`](#enable_default)
    - [`default_options`](#default_options)
  - [Pedantic Example](#pedantic-example)
  - [Hiera Data Bindings](#hiera-data-bindings)
- [Limitations](#limitations)
  - [Tested Platforms](#tested-platforms)
- [Versioning](#versioning)
- [Support](#support)
- [See Also](#see-also)

<!-- /MarkdownTOC -->


<a id="overview"></a>
Overview
--------

Manages the smartmontools package including the smartd daemon


<a id="description"></a>
Description
-----------

Installs the [`smartmontools`](http://smartmontools.sourceforge.net/) package
and enables the `smartd` service and configures as desired.

<a id="forked"></a>
### Forked

This is a fork of
[`jhoblitt/smartd`](https://github.com/jhoblitt/puppet-smartd)


<a id="usage"></a>
Usage
-----


<a id="simple-usage"></a>
### Simple Usage

```puppet
    include smartd
```

```puppet
    class{ 'smartd': }
```

<a id="parameters"></a>
### Parameters

All parameters are optional.

<a id="ensure"></a>
#### `ensure`

`String` defaults to: `present`

Standard Puppet ensure semantics (and supports `purged` state if your package
provider does). Valid values are: `present`,`latest`,`absent`,`purged`

<a id="package_name"></a>
#### `package_name`

`String` defaults to: `smartmontools`

Name of the smartmontools package.

<a id="service_name"></a>
#### `service_name`

`String` defaults to: `smartd`

Name of the smartmontools monitoring daemon.

<a id="service_ensure"></a>
#### `service_ensure`

`String` defaults to: `running`

State of the smartmontools monitoring daemon. Valid values are:
`running`,`stopped`

<a id="config_file"></a>
#### `config_file`

`String` defaults to: (OS-specific)

Path to the configuration file for the monitoring daemon.

<a id="devicescan"></a>
#### `devicescan`

`Bool` defaults to: `true`

Sets the `DEVICESCAN` directive in the smart daemon config file. Tells the
smart daemon to automatically detect all of the SMART-capable drives in the
system.

<a id="devicescan_options"></a>
#### `devicescan_options`

`String` defaults to: `undef`

Passes options to the `DEVICESCAN` directive. `devicescan` must equal `true`
for this to have any effect.

<a id="devices"></a>
#### `devices`

`Array` of `Hash` defaults to: `[]`

Explicit list of raw block devices to check. Eg.

```puppet
    [{ device => '/dev/sda', options => '-I 194' }]
```

<a id="mail_to"></a>
#### `mail_to`

`String` defaults to: `root`

Smart daemon notification email address.

<a id="warning_schedule"></a>
#### `warning_schedule`

`String` defaults to: `daily`

Smart daemon problem mail notification frequency. Valid values are:
`daily`,`once`,`diminishing`, `exec`

If `exec` is selected, a value must be provided to `exec_script`.

<a id="exec_script"></a>
#### `exec_script`

`String` defaults to: `false`

Path to the script that should be executed when problem mail notification
should be sent. This parameter should only be set if `warning_schedule` is set
to `exec`.

<a id="enable_default"></a>
#### `enable_default`

`Bool` defaults to: `false`

Enables/disables the `DEFAULT` directive in the `smartd.conf` file.  This
directive was added in the 5.43 release of smartmontools and is unsupported in
previous versions.

If `enable_default` is set to `false` the the values from the [`mail_to`](#mail-to) and [`warning_schedule`](#warning-schedule) parameters are set on the `DEVICESCAN` directive (if enabled) instead of the [absent] `DEFAULT` directive.

Example `smartd.conf` content based on this setting:

`enable_default => true`
```
# Managed by Puppet -- do not edit!
DEFAULT -m root -M daily
DEVICESCAN
```

`enable_default => false`
```
# Managed by Puppet -- do not edit!
DEVICESCAN -m root -M daily
```

Here is an example of the error message generated by the `DEFFAULT` directive
appearing in the configuration file of 5.42.

```
smartd 5.42 2011-10-20 r3458 [i686-linux-2.6.18-371.6.1.el5PAE] (local build)
Copyright (C) 2002-11 by Bruce Allen, http://smartmontools.sourceforge.net
Opened configuration file /etc/smartd.conf
Drive: DEFAULT, implied '-a' Directive on line 2 of file /etc/smartd.conf
Drive: DEVICESCAN, implied '-a' Directive on line 3 of file /etc/smartd.conf
Configuration file /etc/smartd.conf was parsed, found DEVICESCAN, scanning devices
Device: DEFAULT, unable to autodetect device type
```

This option could not be named `default` to be consistent with the naming
convention of the other parameters in this module due to this bug
[PUP-2244](https://tickets.puppetlabs.com/browse/PUP-2244) that affects puppet
2.7.x.

<a id="default_options"></a>
#### `default_options`

`String` defaults to: `undef`

Additional arguments to be set on the `DEFAULT` directive.

If `default` is set to `false`, this parameter's value will be set on the
`DEVICESCAN` directive (if enabled) instead of the [absent] `DEFAULT`
directive.

<a id="pedantic-example"></a>
### Pedantic Example

```puppet
    class{ 'smartd':
      ensure             => 'present',
      package_name       => 'smartmontools',
      service_name       => 'smartd',
      service_ensure     => 'running',
      config_file        => '/etc/smartd.conf',
      devicescan         => true,
      devicescan_options => '-H -m admin@example.com',
      devices            => [
        { device => '/dev/sg1', options => '-o on -S on -a' },
        { device => '/dev/sg2', options => '-o on -S on -a' },
      ],
      mail_to            => 'root',
      warning_schedule   => 'diminishing',
      default            => 'false',
      default_options    => '-H',
    }
```

<a id="hiera-data-bindings"></a>
### Hiera Data Bindings

```yaml
---
smartd::mail_to: "root@%{::domain}"
smartd::devicescan: false
smartd::devices:
  -
    device: '/dev/cciss/c0d0'
    options: '-d cciss,0 -a -o on -S on -s (S/../.././19|L/../../3/21)'
  -
    device: '/dev/cciss/c0d0'
    options: '-d cciss,1 -a -o on -S on -s (S/../.././18|L/../../3/20)'
  -
    device: '/dev/sda'
    options: '-a -o on -S on -s (S/../.././18|L/../../3/20|C/../.././19)'
```


<a id="limitations"></a>
Limitations
-----------

<a id="tested-platforms"></a>
### Tested Platforms

These are the platforms that have had integration testing since the fork.

* el7.x


<a id="versioning"></a>
Versioning
----------

This module is versioned according to the [Semantic Versioning
2.0.0](http://semver.org/spec/v2.0.0.html) specification.


<a id="support"></a>
Support
-------

Please log tickets and issues at [github](https://github.com/sammcj/puppet-smartd/issues)


<a id="see-also"></a>
See Also
--------

* [`smartmontools`](http://smartmontools.sourceforge.net/)
